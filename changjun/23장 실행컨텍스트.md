## 23장. 실행컨텍스트

## 1. 실행컨텍스트란?

소스코드 평가과정에서 생성하는 것으로 소스코드를 실행하는 데 필요한 환경을 제공하는 영역
즉, 식별자를 등록하고 관리 스코프와 코드 실행 순서를 관리하는 객체다.

- 전역 코드 : 전역 영역에 존재하는 코드
- eval 코드 : eval 함수로 실행되는 코드
- 함수 코드: 함수 내에 존재하는 코드
- 모듈 코드 : 모듈 내부에 존재하는 코드

자바스크립트 엔진은 코드를 실행하기 위하여 실행에 필요한 여러가지 정보를 알고 있어야 한다. 실행에 필요한 여러가지 정보란 아래와 같은 것들이 있다.

- 변수: 전역변수, 지역변수, 매개변수, 객체의 프로퍼티
- 함수 선언
- 변수의 유효범위(scope)
- this

이와 같이 실행에 필요한 정보를 형상화하고 구분하기 위해 자바스크립트 엔진은 실행 컨텍스트를 물리적 객체의 형태로 관리한다.

```javascript
var x = 'xxx';

function foo() {
  var y = 'yyy';

  function bar() {
    var z = 'zzz';
    console.log(x + y + z);
  }
  bar();
}
foo();
```

## 3. 실행 컨텍스트 스택

위 코드를 실행하면 아래와 같이 실행 컨텍스트 스택(Stack)이 생성하고 소멸한다. 현재 실행 중인 컨텍스트에서 이 컨텍스트와 관련없는 코드(예를 들어 다른 함수)가 실행되면 새로운 컨텍스트가 생성된다. 이 컨텍스트는 스택에 쌓이게 되고 컨트롤(제어권)이 이동한다.

1. 컨트롤이 실행 가능한 코드로 이동하면 논리적 스택 구조를 가지는 새로운 실행 컨텍스트 스택이 생성된다. 스택은 LIFO(Last In First Out, 후입 선출)의 구조를 가지는 나열 구조이다.

2. 전역 코드(Global code)로 컨트롤이 진입하면 전역 실행 컨텍스트가 생성되고 실행 컨텍스트 스택에 쌓인다. 전역 실행 컨텍스트는 애플리케이션이 종료될 때(웹 페이지에서 나가거나 브라우저를 닫을 때)까지 유지된다.

3. 함수를 호출하면 해당 함수의 실행 컨텍스트가 생성되며 직전에 실행된 코드 블록의 실행 컨텍스트 위에 쌓인다.

4. 함수 실행이 끝나면 해당 함수의 실행 컨텍스트를 파기하고 직전의 실행 컨텍스트에 컨트롤을 반환한다.

## 4. 실행 컨텍스트 생성 과정

### 4.1 전역 코드 평가

1. 전역 객체 생성
2. 전역 실행 컨텍스트 생성 후 실행 컨텍스트 스택에 푸시
3. 전역 렉시컬 환경 생성 후 전역 실행 컨텍스트에 바인딩  
   3-1. 객체 환경 레코드생성 후 BindingObject에 전역 객체 바인딩  
   3-2. 선억적 환경 레코드생성 후 let or const를 이용해 선언한 전역 변수 등록
4. this바인딩
5. 외부 렉시컬 환경에 대한 참조 결정
6. 전역 코드 실행

### 4.2 함수 코드 평가

1. 함수 실행 컨텍스트 생성 후 실행 컨텍스트 스택에 푸시 ( 제어권을 넘겨받음 )
2. 함수 렉시컬 환경 생성 후 함수 실행 컨텍스트에 바인딩
   2-1. 함수 환경 레코드 생성 후 매개변수, arguments, 함수내부 지역변수들 등록  
   2-2. this 바인딩  
   2-3. 외부 렉시컬 환경에 대한 참조 결정내부슬롯에 저장

### 5. 식별자 검색

1. 식별자에 대한 참조가 있을 경우 렉시컬 환경 내에서 검색한다.
2. 만약 존재하기 않을 경우 외부 렉시컬 환경에 대한 참조가 가리키는 렉시컬 환경으로 이동하여 검색하는 것을 반복한다.
3. 전역 렉시컬 환경에 찾지 못했다면 외부 렉시컬 환경에 대한 참조가 `null`이 아니라 `undefined`로 반환된다

## 6. 실행 종료

함수의 코드끝을 만나 종료를 하게 된다면 현재 함수의 실행 컨텍스트가 스택에서 제거된다. **실행 컨텍스트 스택에서 제거될 뿐이지 전체 실행컨텍스트 자체가 제거되는것은 아니다.**

가비지컬렉터가 발생하는 원리는 해당 값을 참조하는 일이 없을 때 이다. 즉, 실행 컨텍스트 내부에서 정의되어있는 변수들이 외부에서 사용하게 된다면 실행컨텍스트를 제거하지 않는것 (클로저의 개념)
