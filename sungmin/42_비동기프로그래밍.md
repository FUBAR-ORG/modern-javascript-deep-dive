# 42장 비동기 프로그래밍

## 동기 처리와 비동기 처리

- 자바스크립트 싱글 스레드 방식으로 동작하며 단 하나의 실행 컨텍스트를 갖는다.
- 싱글 스레드 방식은 한 번에 하나의 태스크만 실행할 수 있기 때문에 처리에 시간이 걸리는 태스크를 실행하는 경우 블로킹이 발생한다.

### 동기 처리

- 동기 처리는 현재 실행중인 태스크가 종료할 때까지 다음에 실행될 태스크가 대기하는 방식이다.
- 순서대로 처리하므로 실행 순서가 보장되지만 앞선 태스크가 종료할 때까지 이후 태스크가 블로킹된다.

```js
function sleep(func, delay) {
	const dealyUntil = Date.now() + delay;

	while(Date.now() < delayUntil);

	func();
}

function foo() {
	console.log(foo);
}

function bar() {
	console.log(foo);
}

sleep(foo, 3 * 1000);
bar();
```

### 비동기 처리

- 비동기 처리는 실행 중인 태스크가 종료되지 않은 상태라고 해도 다음 태스크를 곧바로 실행하는 방식이다.
- 동기 처리와 반대로 블로킹이 발생하지 않지만 실행 순서가 보장되지 않는다.
- setTimeout, setInterval, HTTP 요청, 이벤트 핸들러는 비동기 처리 방식으로 동작한다.

```js
function foo() {
	console.log(foo);
}

function bar() {
	console.log(foo);
}

setTimeout(foo, 3 * 1000);
bar();
```

<br>

## 이벤트 루프와 태스크 큐

- 자바스크립트는 싱글 스레드 방식으로 한 번에 하나만 처리할 수 있지만 브라우저가 동작하는 것을 보면 태스크가 동시에 처리되는 것처럼 느껴진다.
- 자바스크립트 동시성을 지원하는 것이 바로 이벤트 루프이며 브라우저에 내장되어 있는 기능이다.

### 이벤트 루프

구글 V8 엔진을 비롯한 대부분의 자바스크립트 엔진은 2개의 영역으로 구분할 수 있다.

- 콜 스택: 소스코드가 평가되고 생성된 실행 컨텍스트가 관리되는 스택이다.
- 힙: 객체가 저장되는 메모리 공간이며 실행 컨텍스트는 힙에 저장된 객체를 참조한다. 객체는 런타임에 크기가 결정되므로 구조화되어 있지 않다.

비동기 처리에서 소스코드의 평가와 실행을 제외한 모든 처리는 엔진을 구동하는 환경인 브라우저 또는 Node.js가 담당한다. 이를 위해 브라우저 환경은 태스크 큐와 이벤트 루프를 제공한다.

- 태스크 큐(task queue, event queue, callback queue): 비동기 함수의 콜백 함수 또는 이벤트 핸들러가 일시적으로 보관된다.
- 이벤트 루프: 콜 스택이 비어있고 태스크 큐에 대기중인 함수가 있다면 이벤트 루프는 태스크 큐에 대기중인 함수를 콜 스택으로 이동시킨다.

아래 예제 코드는 다음과 같이 실행된다.

```js
function foo() {
  console.log('foo');
}

function bar() {
  console.log('bar');
}

setTimeout(foo, 0); // 실제는 4ms(최소 지연 시간)후에 foo 함수가 호출된다.
bar();
```

1. 전역 코드가 평가되어 전역 실행 컨텍스트가 생성되고 콜 스택에 푸시된다.
2. 전역 코드가 실행되어 setTimeout 함수가 호출되어 함수 실행 컨텍스트가 생성되고 콜 스택에 푸시된다.
    - 브라우저의 Web API(호스트 객체)인 타이머 함수도 함수이므로 실행 컨텍스트를 생성한다.
3. setTimeout 함수가 실행되면 콜백 함수를 호출 스케줄링하고 종료되어 콜 스택에서 팝된다.
4. 4-1, 4-2 과정이 병행 처리된다.
   4-1. 브라우저는 타이머를 설정하고 타이머 만료되면 콜백 함수 foo가 태스크 큐에 푸시된다.(by 브라우저)
   4-2. bar 함수가 호출되어 실행 컨텍스트가 생성되고 콜 스택에 푸시되어 현재 실행중인 실행 컨텍스트가 된다.(by 자바스크립트 엔진)
    - foo 함수는 아직 태스크 큐에서 대기중.
5. 전역 코드 실행이 종료되고 전역 실행 컨텍스트가 콜 스택에서 팝된다.
    - 콜 스택이 빈 상태가 된다.
6. **이벤트 루프에 의해 콜 스택이 비어있음이 감지되고 태스크 큐의 콜백 함수 foo가 이벤트 루프에 의해 푸시된다.** foo 함수의 실행 컨텍스트가 생성되고 콜 스택에 푸시되어 실행되고 종료 후 콜 스택에서 pop 된다.

**자바스크립트 엔진은 싱글 스레드로 동작하지만 브라우저는 멀티 스레드로 동작한다.**

---

### Summary

- 동기 처리는 현재 실행중인 태스크가 종료할 때까지 다음에 실행될 태스크가 대기하는 방식이며 태스크의 블로킹이 발생한다.
- 비동기 처리는 실행 중인 태스크가 종료되지 않은 상태라고 해도 다음 태스크를 곧바로 실행하는 방식이며 실행 순서가 보장되지 않는다.
- 자바스크립트 엔진은 콜 스택과 힙으로 구성된다.
- 브라우저, Node.js 환경은 태스크 큐와 이벤트 루프를 제공한다.
- 비동기 함수의 콜백 함수 또는 이벤트 핸들러는 태스크 큐에 일시적으로 보관된다.
- 콜 스택이 비어있고 태스크 큐에 대기중인 함수가 있다면 이벤트 루프는 FIFO로 태스크 큐에 대기중인 함수를 콜 스택으로 이동시킨다.
- 자바스크립트 엔진은 싱글 스레드로 동작하지만 브라우저는 멀티 스레드로 동작한다.

---
